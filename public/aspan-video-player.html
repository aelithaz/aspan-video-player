<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Video Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        video {
            width: 80%;
            max-width: 800px;
            display: block;
            margin: auto;
        }
        .controls {
            margin-top: 10px;
        }
        button, select {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #00e2e6;
            color: rgb(0, 0, 0);
            border: none;
            border-radius: 5px;
        }
        .progress-container {
            width: 80%;
            max-width: 800px;
            height: 10px;
            background-color: #ddd;
            margin: 10px auto;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: #4caf50;
        }
        .chunk-markers {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .chunk-marker {
            position: absolute;
            width: 2px;
            height: 100%;
            background-color: black;
            /* Change to 0.5 to show chunk markers for debugging */
            opacity: 0; 
        }
    </style>
</head>
<body>
    <h2>Survey Video Player</h2>

    <label for="videoSelector">Select Video:</label>
    <select id="videoSelector" onchange="changeVideo()">
        <option value="wealthReport.mp4">Wealth Report</option>
        <option value="genderEquality.mp4">Gender Equality</option>
        <option value="branding.mp4">Branding</option>
    </select>

    <video id="surveyVideo">
        <source id="videoSource" src="videos/wealthReport.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="progress-container" id="progressContainer" onclick="seekVideo(event)">
        <div class="progress-bar" id="progressBar"></div>
        <div class="chunk-markers" id="chunkMarkers"></div>
    </div>

    <div class="controls">
        <button onclick="playVideo()">‚ñ∂ Play</button>
        <button onclick="pauseVideo()">‚è∏ Pause</button>
        <button onclick="rewind(10)">‚è™ Rewind 10s</button>
        <label for="speedSelector">Playback Speed:</label>
        <label for="volumeSlider">Volume:</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
        <!-- Handles changing video speed -->
        <!-- <select id="speedSelector" onchange="changeSpeed()">
            <option value="1">1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
        </select> -->
    </div>

    <div id="quizContainer"></div>

    <script>
        const video = document.getElementById("surveyVideo");
        const videoSource = document.getElementById("videoSource");
        const videoSelector = document.getElementById("videoSelector");
        const progressBar = document.getElementById("progressBar");
        const progressContainer = document.getElementById("progressContainer");
        const chunkMarkers = document.getElementById("chunkMarkers");
        const chunkSize = 5; // 5-second chunks
        let chunkViews = {}; // Stores chunk views per video
        let lastChunk = -1; // Tracks last recorded chunk
        let currentVideo = "wealthReport.mp4"; // Default video
        let manualSeek = false; // Tracks manual seeking
        let seekWhilePaused = false; // Checks if seeking is done while paused

        function initializeTracking() {
            video.onloadedmetadata = () => {
                let numChunks = Math.ceil(video.duration / chunkSize);
                if (!chunkViews[currentVideo]) {
                    chunkViews[currentVideo] = {};
                    for (let i = 0; i < numChunks; i++) {
                        chunkViews[currentVideo][i] = 0;
                    }
                }
                createChunkMarkers(numChunks);
            };
        }

        video.ontimeupdate = () => {
            const progress = (video.currentTime / video.duration) * 100;
            progressBar.style.width = progress + "%";
            if (!manualSeek) {
                trackChunkViews();
            }
        };

        function trackChunkViews() {
            let currentChunk = Math.floor(video.currentTime / chunkSize);
            if (currentChunk !== lastChunk) { 
                chunkViews[currentVideo][currentChunk] = (chunkViews[currentVideo][currentChunk] || 0) + 1;
                lastChunk = currentChunk;
            }
        }

        function changeVideo() {
            currentVideo = videoSelector.value;
            video.pause();
            videoSource.src = "videos/" + currentVideo;
            video.load();
            lastChunk = -1; // Reset chunk tracking
            video.currentTime = 0;
            progressBar.style.width = "0%"; 
            initializeTracking();
            renderQuiz(currentVideo);
        }

        function generateUserId() {
            let uid = sessionStorage.getItem('uid');
            if (!uid) {
                uid = Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('uid', uid);
            }
            return uid;
        }

        const uid = generateUserId();  // Call only ONCE at the start

        function submitDataToServer() {
            const orderedVideos = ["wealthReport.mp4", "genderEquality.mp4", "branding.mp4"];

            for (const video in orderedVideos) {
                const videoChunks = chunkViews[video];

                // Only send if any chunks have a count > 0
                const hasViews = Object.values(videoChunks).some(count => count > 0);
                if (!hasViews) continue;

                const correctAnswers = quizAnswers[video]?.filter((entry, i) =>
                    entry?.selectedIndex === quizzes[video][i].correct
                ).length || 0;

                const selectedAnswers = quizAnswers[video]?.map((entry, i) => ({
                    question: quizzes[video][i].question,
                    selected: entry?.selectedText || null
                })) || [];

                const payload = {
                    userId: uid,
                    video: video,
                    chunkViews: videoChunks,
                    timestamp: new Date().toISOString(),
                    quizCorrect: correctAnswers,
                    selectedAnswers: selectedAnswers
                };

                const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
                console.log("üîî Sending beacon with payload:", payload);
                const success = navigator.sendBeacon("https://aspan-video-player.onrender.com/api/view", blob);
                console.log("üì§ Beacon success:", success);
            }
        }

        function playVideo() {
            if (video.currentTime >= video.duration) {
                lastChunk = -1;
            }

            if (seekWhilePaused) {
                setTimeout(() => {
                    trackChunkViews();     
                    seekWhilePaused = false;
                }, 100);
            }

            video.play();
            manualSeek = false;
        }

        function pauseVideo() { video.pause(); }

        function rewind(seconds) {
            video.currentTime = Math.max(video.currentTime - seconds, 0);
            setTimeout(() => {
                trackChunkViews();  // update new chunk after seeking
            }, 100);
        }

        // Handles changing video speed
        // function changeSpeed() {
        //     const speedSelector = document.getElementById("speedSelector");
        //     video.playbackRate = parseFloat(speedSelector.value);
        // }

        function createChunkMarkers(numChunks) {
            chunkMarkers.innerHTML = "";
            for (let i = 0; i < numChunks; i++) {
                const marker = document.createElement("div");
                marker.classList.add("chunk-marker");
                marker.style.left = (i / numChunks * 100) + "%";
                chunkMarkers.appendChild(marker);
            }
        }

        function seekVideo(event) {
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const newTime = (clickX / rect.width) * video.duration;
            video.currentTime = newTime;
            manualSeek = true;

            if (video.paused) {
                seekWhilePaused = true;  
            } else {
                setTimeout(() => {
                    trackChunkViews();
                    manualSeek = false;
                }, 100);
            }
        }

        let dataAlreadySent = false;

        // Send data on video end
        // video.onended = () => {
        //     if (!dataAlreadySent) {
        //         submitDataToServer();
        //         dataAlreadySent = true;
        //     }
        // };

        document.getElementById("volumeSlider").addEventListener("input", function () {
            video.volume = parseFloat(this.value);
        });

        const quizzes = {
            "wealthReport.mp4": [
                {
                    question: "Which of these inferences can be made from the video?",
                    options: [
                        "2022 resulted in a real wealth loss and real estate may weaken if housing prices drop",
                        "2022 resulted in a real wealth loss and real estate may become stronger if housing prices drop",
                        "2022 resulted in a real wealth gain and real estate may weaken if housing prices drop",
                        "2022 resulted in a real wealth gain and real estate may become stronger if housing prices drop"
                    ],
                    correct: 0
                },
                {
                    question: "About how much was the drop in global household wealth, as reported by the 2023 Credit Suisse Global Wealth Report?",
                    options: ["1 trillion", "5 trillion", "10 trillion", "20 trillion"],
                    correct: 2
                },
                {
                    question: "Which of these options matches regional wealth trends shown in the video?",
                    options: [
                        "Gains in North America and Latin America and losses in Europe",
                        "Gains in North America and Europe and losses in Latin America",
                        "Gains in Europe and losses in North America and Latin America",
                        "Gains in Latin America and Losses in North America and Europe"
                    ],
                    correct: 3
                },
                {
                    question: "Which of these options matches the information mentioned in the video?",
                    options: [
                        "The top 1%‚Äôs wealth share dropped as did the number of millionaires; median global wealth grew",
                        "The top 1%‚Äôs wealth share dropped; median global wealth grew as did the number of millionaires",
                        "The top 1%‚Äôs wealth share rose as did the number of millionaires; median global wealth dropped",
                        "The top 1%‚Äôs wealth share grew; median global wealth dropped as did the number of millionaires"
                    ],
                    correct: 0
                },
                {
                    question: "Around how much was the estimated change in global wealth by 2027?",
                    options: ["40% decrease", "40% increase", "20% decrease", "20% increase"],
                    correct: 1
                }
            ],
            "genderEquality.mp4": [
                {
                    question: "Which is not an issue women face mentioned in the video?",
                    options: [
                        "The majority of mothers with newborns do not receive maternity cash benefits",
                        "Women are at greater risk of food insecurity than men",
                        "Sex and/or gender is rarely considered in the development of safety equipment",
                        "Sex and/or gender was rarely considered in COVID-19 research"
                    ],
                    correct: 2
                },
                {
                    question: "Which is not an issue women face in the workplace and at home mentioned in the video?",
                    options: [
                        "The pandemic intensified women‚Äôs workload at home",
                        "Reports of violence against women and girls are increasing in many parts of the world",
                        "Women are not paid as much as men are",
                        "Women suffered steeper job losses than men during the pandemic"
                    ],
                    correct: 2
                },
                {
                    question: "What is the approximate ratio of parliamentary seats held by women?",
                    options: ["One in two", "One in three", "One in four", "One in five"],
                    correct: 2
                },
                {
                    question: "How many SDG5 goals were met or almost met according to the latest global assessment of total level?",
                    options: ["0", "1", "2", "3"],
                    correct: 0
                },
                {
                    question: "What year was set as the previous goal for achieving gender equality and women‚Äôs empowerment?",
                    options: ["2025", "2030", "2035", "2040"],
                    correct: 1
                }
            ],
            "branding.mp4": [
                {
                    question: "Which of the following options best matches how the video initially describes a brand?",
                    options: ["A logo", "Advertising", "Marketing", "A set of unique values", "Corporate identity"],
                    correct: 3
                },
                {
                    question: "In 2010, how did the value of Coca-cola compare to the GDPs of Bolivia, Kenya, and Bahrain?",
                    options: [
                        "Just under their total GDP",
                        "Over their total GDP",
                        "Around the average of their GDPs",
                        "Over any one of their GDPs"
                    ],
                    correct: 1
                },
                {
                    question: "Which of these options was not mentioned as something that could be branded?",
                    options: ["Services", "People", "Places", "Emotions", "Religions"],
                    correct: 3
                },
                {
                    question: "What does the video mention as a remarkable achievement for a brand?",
                    options: [
                        "When the brand becomes a verb",
                        "When the brand can afford advertisements featuring high profile celebrities",
                        "When the brand becomes a synonym for its product",
                        "When the brand is too large to fail"
                    ],
                    correct: 0
                },
                {
                    question: "Which of the following is not a function of a brand mentioned in the video?",
                    options: ["Finding information", "Sharing films", "Making music", "Making friends", "Adding to knowledge"],
                    correct: 2
                }
            ]
        };

        let quizAnswers = {}; // Store user's selected answers

        function renderQuiz(videoName) {
            const quizContainer = document.getElementById("quizContainer");
            quizContainer.innerHTML = ""; // Clear previous

            const quiz = quizzes[videoName];
            if (!quiz) return;

            quizAnswers[videoName] = [];

            quiz.forEach((q, idx) => {
                const div = document.createElement("div");
                div.innerHTML = `<p><strong>Q${idx + 1}: ${q.question}</strong></p>` + 
                    q.options.map((opt, i) => `
                        <label>
                            <input type="radio" name="q${idx}" value="${i}" onchange="selectAnswer('${videoName}', ${idx}, ${i})">
                            ${opt}
                        </label><br>
                    `).join("");
                quizContainer.appendChild(div);
            });
        }

        function selectAnswer(videoName, questionIndex, answerIndex) {
            const quiz = quizzes[videoName];
            if (!quizAnswers[videoName]) quizAnswers[videoName] = [];

            quizAnswers[videoName][questionIndex] = {
                selectedIndex: answerIndex,
                selectedText: quiz[questionIndex].options[answerIndex]
            };
        }


        window.addEventListener("pagehide", () => {
            if (!dataAlreadySent) {
                submitDataToServer();
                dataAlreadySent = true;
            }
        });

        initializeTracking();
    </script>
</body>
</html>